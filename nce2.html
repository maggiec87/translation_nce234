<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ¦‚å¿µ2ç¿»è¯‘ç»ƒä¹ </title>
    <style>
        /* ===============================================
         * ä¿ç•™æ‚¨åŸå§‹çš„æ‰€æœ‰æ ·å¼ (CSS)
         * ===============================================
        */
        :root {
            --primary-color: #007aff;
            --primary-hover-color: #0056b3;
            --success-color: #28a745;
            --success-bg-color: #e9f7ef;
            --error-color: #dc3545;
            --error-bg-color: #fbebed;
            --warning-color: #e74c3c;
            --warning-hover-color: #c0392b;
            --neutral-color: #6c757d;
            --neutral-hover-color: #5a6268;
            --text-color: #343a40;
            --text-light-color: #6c757d;
            --bg-color: #f8f9fa;
            --container-bg-color: #ffffff;
            --border-color: #dee2e6;
            --border-radius: 8px;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; background-color: var(--container-bg-color); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        h1, h3 { text-align: center; color: var(--text-color); margin-top: 0; }
        .hidden { display: none; }

        /* å¸ƒå±€ç»„ä»¶ */
        .section { background: #fff; border: 1px solid var(--border-color); padding: 20px; border-radius: var(--border-radius); margin-bottom: 25px; }
        .control-group { margin-bottom: 15px; }
        label { font-weight: 600; margin-right: 10px; color: var(--text-color); }

        /* æŒ‰é’®æ ·å¼ - ä¿ç•™æ‚¨çš„åŸå§‹é£æ ¼ */
        button { padding: 10px 20px; border-radius: var(--border-radius); border: none; cursor: pointer; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-neutral { background-color: var(--neutral-color); color: white; }
        
        /* é’ˆå¯¹æœ¬é¡µé¢çš„è¿”å›æŒ‰é’® */
        .btn-home { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; margin-bottom: 20px; text-decoration: none; font-size: 14px; padding: 5px 15px; border-radius: 4px; display: inline-flex; align-items: center; }

        /* ç»ƒä¹ äº¤äº’åŒº */
        textarea { width: 100%; height: 120px; padding: 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1.1em; resize: vertical; margin: 15px 0; box-sizing: border-box; }
        .sentence-display { font-size: 1.3em; font-weight: 700; background-color: #f1f3f5; padding: 20px; border-radius: var(--border-radius); border-left: 5px solid var(--primary-color); margin-bottom: 15px; }

        /* å¯¹æ¯”åé¦ˆåŒº */
        .feedback-card { margin-top: 20px; padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--border-color); background: #fafafa; }
        .feedback-item { margin-bottom: 10px; }
        .feedback-label { font-weight: bold; color: var(--text-light-color); margin-right: 8px; }
        .diff-added { background-color: #ffdce0; text-decoration: line-through; color: #b31d28; } /* æ ‡è®°å¤šä½™/é”™è¯¯çš„è¯ */
        
        /* å…¨æ–‡æ˜¾ç¤ºåŒº */
        #fullCorpusContent { margin-top: 15px; padding: 15px; background: #fdfdfd; border: 1px solid #eee; max-height: 300px; overflow-y: auto; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <a href="index.html" class="btn-home">ğŸ  ä¸»é¡µ</a>

    <h1>æ–°æ¦‚å¿µ2ç¿»è¯‘ç»ƒä¹ </h1>

    <div id="translation-module">
        <div id="translationPracticeSettings" class="section">
            <h3>ç»ƒä¹ è®¾ç½®</h3>
            <div class="control-group">
                <label>é€‰æ‹©è¯­æ–™:</label>
                <select id="translationCorpusSelect" onchange="updateFullCorpusView()" style="padding:8px; border-radius:4px; border:1px solid #ccc;"></select>
                <button class="btn-neutral" onclick="toggleFullCorpus()" style="padding:5px 10px; font-size:12px;">æŸ¥çœ‹å…¨æ–‡</button>
                <button class="btn-success" id="exportCorpusBtn" style="padding:5px 10px; font-size:12px;">å¯¼å‡ºé¢˜åº“</button>
            </div>
            
            <div id="fullCorpusContent" class="hidden"></div>

            <div class="control-group">
                <label>é¡ºåºé€‰æ‹©:</label>
                <input type="radio" id="orderSeq" name="order" value="sequential" checked> <label for="orderSeq" style="font-weight:400">é¡ºåº</label>
                <input type="radio" id="orderRand" name="order" value="random"> <label for="orderRand" style="font-weight:400">éšæœº</label>
            </div>

            <div class="control-group">
                <label>ç»ƒä¹ æ–¹å‘:</label>
                <input type="radio" id="dirCE" name="dir" value="ce" checked> <label for="dirCE" style="font-weight:400">ä¸­è¯‘è‹±</label>
                <input type="radio" id="dirEC" name="dir" value="ec"> <label for="dirEC" style="font-weight:400">è‹±è¯‘ä¸­</label>
            </div>

            <div class="control-group">
                <label>ç»ƒä¹ é¢˜é‡:</label>
                <input type="number" id="practiceCount" value="0" style="width: 60px; padding:5px;"> (0ä¸ºå…¨éƒ¨)
            </div>

            <button id="startTranslationPracticeBtn" class="btn-primary" style="width:100%; margin-top:10px;">ğŸš€ å¼€å§‹ç»ƒä¹ </button>
        </div>

        <div id="translationPracticeArea" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span id="progressText" style="color:var(--text-light-color); font-weight:600;">è¿›åº¦: 0 / 0</span>
            </div>
            
            <div id="sourceSentence" class="sentence-display"></div>
            
            <textarea id="translationInput" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„è¯‘æ–‡..."></textarea>

            <div class="btn-group" style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="submitTranslationBtn" class="btn-primary">âœ… æäº¤</button>
                <button id="skipTranslationBtn" class="btn-neutral">â­ï¸ è·³è¿‡</button>
                <button id="nextTranslationSentenceBtn" class="btn-success hidden">â¡ï¸ ä¸‹ä¸€å¥</button>
                <button id="translationEndPracticeBtn" class="btn-warning">â¹ï¸ ç»“æŸ</button>
            </div>

            <div id="feedbackArea" class="feedback-card hidden">
                <div class="feedback-item">
                    <span class="feedback-label">ä¸­æ–‡åŸæ–‡:</span> <span id="resZh"></span>
                </div>
                <div class="feedback-item">
                    <span class="feedback-label">æ‚¨çš„è¯‘æ–‡:</span> <span id="resUser"></span>
                </div>
                <div class="feedback-item">
                    <span class="feedback-label">æ ‡å‡†åŸå¥:</span> <span id="resEn"></span>
                </div>
            </div>
        </div>

        <div id="translationResultsSummary" class="section hidden" style="margin-top:20px;">
            <h3>ç»ƒä¹ æ±‡æ€»</h3>
            <div id="resultsList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; border:1px solid #eee; padding:10px;"></div>
            <button id="exportSessionBtn" class="btn-success">ğŸ“¥ å¯¼å‡ºæœ¬æ¬¡</button>
        </div>
    </div>

    <button id="exportHistoryBtn" class="btn-neutral" style="width:100%; margin-top:40px;">ğŸ“Š å¯¼å‡ºå†å²</button>
</div>

<script src="data_nce2.js"></script>
<script>
    let currentCorpus = null;
    let sessionSentences = [];
    let currentIndex = 0;
    let sessionData = []; // ç”¨äºå¯¼å‡ºæœ¬æ¬¡ç»“æœ
    let direction = 'ce';

    // åˆå§‹åŒ–
    window.onload = () => {
        if (typeof corpuses !== 'undefined') {
            const select = document.getElementById('translationCorpusSelect');
            corpuses.forEach(c => {
                let opt = document.createElement('option');
                opt.value = c.id; opt.textContent = c.name;
                select.appendChild(opt);
            });
            updateFullCorpusView();
        }
    };

    function updateFullCorpusView() {
        const id = document.getElementById('translationCorpusSelect').value;
        currentCorpus = corpuses.find(c => c.id === id);
        const content = document.getElementById('fullCorpusContent');
        content.innerHTML = currentCorpus.sentences.map((s, i) => `<div style="margin-bottom:8px;">${i+1}. ${s.en}<br><small style="color:#888">${s.zh}</small></div>`).join('');
    }

    function toggleFullCorpus() {
        document.getElementById('fullCorpusContent').classList.toggle('hidden');
    }

    // å¼€å§‹ç»ƒä¹ 
    document.getElementById('startTranslationPracticeBtn').onclick = () => {
        direction = document.querySelector('input[name="dir"]:checked').value;
        const isRand = document.getElementById('orderRand').checked;
        const count = parseInt(document.getElementById('practiceCount').value);

        sessionSentences = [...currentCorpus.sentences];
        if (isRand) sessionSentences.sort(() => Math.random() - 0.5);
        if (count > 0) sessionSentences = sessionSentences.slice(0, count);

        currentIndex = 0;
        sessionData = [];
        document.getElementById('translationPracticeSettings').classList.add('hidden');
        document.getElementById('translationResultsSummary').classList.add('hidden');
        document.getElementById('translationPracticeArea').classList.remove('hidden');
        showSentence();
    };

    function showSentence() {
        if (currentIndex >= sessionSentences.length) { finishSession(); return; }
        const data = sessionSentences[currentIndex];
        document.getElementById('sourceSentence').textContent = direction === 'ce' ? data.zh : data.en;
        document.getElementById('progressText').textContent = `è¿›åº¦: ${currentIndex + 1} / ${sessionSentences.length}`;
        
        document.getElementById('translationInput').value = "";
        document.getElementById('translationInput').disabled = false;
        document.getElementById('feedbackArea').classList.add('hidden');
        document.getElementById('submitTranslationBtn').classList.remove('hidden');
        document.getElementById('skipTranslationBtn').classList.remove('hidden');
        document.getElementById('nextTranslationSentenceBtn').classList.add('hidden');
    }

    // æäº¤é€»è¾‘
    document.getElementById('submitTranslationBtn').onclick = () => {
        const data = sessionSentences[currentIndex];
        const userVal = document.getElementById('translationInput').value.trim();
        const refVal = direction === 'ce' ? data.en : data.zh;

        // å­˜å‚¨æ•°æ®
        const record = {
            time: new Date().toLocaleString(),
            lesson: currentCorpus.name,
            zh: data.zh,
            en: data.en,
            user: userVal
        };
        sessionData.push(record);
        saveToHistory(record);

        // UI åé¦ˆ
        document.getElementById('resZh').textContent = data.zh;
        document.getElementById('resEn').textContent = data.en;
        document.getElementById('resUser').innerHTML = diffCompare(userVal, refVal);

        document.getElementById('feedbackArea').classList.remove('hidden');
        document.getElementById('translationInput').disabled = true;
        document.getElementById('submitTranslationBtn').classList.add('hidden');
        document.getElementById('skipTranslationBtn').classList.add('hidden');
        document.getElementById('nextTranslationSentenceBtn').classList.remove('hidden');
    };

    document.getElementById('nextTranslationSentenceBtn').onclick = () => { currentIndex++; showSentence(); };
    document.getElementById('skipTranslationBtn').onclick = () => { currentIndex++; showSentence(); };
    document.getElementById('translationEndPracticeBtn').onclick = () => { if(confirm("ç¡®å®šç»“æŸæœ¬æ¬¡ç»ƒä¹ ï¼Ÿ")) finishSession(); };

    function finishSession() {
        document.getElementById('translationPracticeArea').classList.add('hidden');
        document.getElementById('translationPracticeSettings').classList.remove('hidden');
        if (sessionData.length > 0) {
            document.getElementById('translationResultsSummary').classList.remove('hidden');
            document.getElementById('resultsList').innerHTML = sessionData.map(d => `<div>â€¢ ${d.zh} -> ${d.user || '(è·³è¿‡)'}</div>`).join('');
        }
    }

    // å¯¹æ¯”ç®—æ³•
    function diffCompare(user, ref) {
        if (!user) return "<i>(æœªè¾“å…¥)</i>";
        const userWords = user.split(/\s+/);
        const refLower = ref.toLowerCase();
        return userWords.map(w => {
            const clean = w.toLowerCase().replace(/[.,!?;]/g, '');
            return (clean && refLower.includes(clean)) ? w : `<span class="diff-added">${w}</span>`;
        }).join(' ');
    }

    // å¯¼å‡º CSV é€»è¾‘
    function downloadCSV(csv, filename) {
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }

    document.getElementById('exportCorpusBtn').onclick = () => {
        let csv = "è‹±æ–‡,ä¸­æ–‡\n" + currentCorpus.sentences.map(s => `"${s.en}","${s.zh}"`).join("\n");
        downloadCSV(csv, `é¢˜åº“_${currentCorpus.name}.csv`);
    };

    document.getElementById('exportSessionBtn').onclick = () => {
        let csv = "ä¸­æ–‡,æ ‡å‡†åŸå¥,æ‚¨çš„è¯‘æ–‡\n" + sessionData.map(d => `"${d.zh}","${d.en}","${d.user}"`).join("\n");
        downloadCSV(csv, "æœ¬æ¬¡ç»ƒä¹ è®°å½•.csv");
    };

    function saveToHistory(item) {
        let history = JSON.parse(localStorage.getItem('nce_history') || '[]');
        history.push(item);
        localStorage.setItem('nce_history', JSON.stringify(history));
    }

    document.getElementById('exportHistoryBtn').onclick = () => {
        let history = JSON.parse(localStorage.getItem('nce_history') || '[]');
        if (history.length === 0) { alert("æš‚æ— å†å²è®°å½•"); return; }
        let csv = "æ—¶é—´,è¯¾æ—¶,ä¸­æ–‡,æ ‡å‡†åŸå¥,æ‚¨çš„è¯‘æ–‡\n" + history.map(d => `"${d.time}","${d.lesson}","${d.zh}","${d.en}","${d.user}"`).join("\n");
        downloadCSV(csv, "æ‰€æœ‰å†å²å·²ç»ƒä¹ è®°å½•.csv");
    };
</script>

</body>
</html>